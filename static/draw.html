<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>DrawIt Canvas</title>
	<link rel="stylesheet" href="/static/draw.css">
	<script src="/static/external/qrcode.min.js"></script>
	<script src="/static/external/panzoom.min.js"></script>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
		rel="stylesheet">
</head>


<body>

	<div class="ui-layer">
		<div id="colorOverlay" class="overlay">
			<div id="colorGrid" class="color-grid"></div>
		</div>

		<div class="top" id="toolstop">
			<div class="toolbar">
				<div id="colorMenuBtn" class="colorbtn"></div>

				<div id="radiusTools" title="Choose pen radius">
					<input type="range" id="radiusSlider" min="1" max="20" value="8">
					<span id="radiusValue">8</span>
				</div>

			</div>

		</div>


		<div id="modeSwitch" title="Toggle Mode" class="button">
			<img class="show-in-drawing" src="/static/Icons/Move%20icon.svg" alt="Switch to View">

			<img class="show-in-view" src="/static/Icons/Draw%20icon.svg" alt="Switch to Draw">
		</div>

		<div id="usersCount" title="Users connected">
			<p id="count">5</p>
			<img class="show-in-drawing" height="20px" style="margin-left: 5px;" src="/static/Icons/people.svg"
				alt="Switch to View">

		</div>


	</div>


	<div id="viewport">
		<div id="canvas-container" style="width:3840px; height:2160px">
			<canvas id="back" width="3840" height="2160"></canvas>
			<canvas id="top" width="3840" height="2160"></canvas>
		</div>
	</div>


	<script>
		if (window.location.pathname == "/plan") {
			let qrcode = new QRCode("qrcode", window.location.origin + "/draw");
			const color = document.getElementById("colorMenuBtn");
			color.style.display = "none";
			const rad = document.getElementById("radiusTools");
			rad.style.display = "none";
			const usr = document.getElementById("usersCount");
			usr.style.top = 20;
		} else {
			const qr = document.getElementById("qrcode");
			qr.style.display = "none";
		}
	</script>

	<script type="module">
		import {setupWebsocket} from "/static/websockets.js";
		import {DrawingModule, allotherthings} from '/static/draw.js';
		import {Event, DrawingEventType} from "/static/events.js"
		import {Map} from "/static/map.js"
		
		//audio
		const audio = new Audio('assets/button.wav');

		const isDraw = window.location.pathname == "/draw"
		
		if(isDraw) {
			document.getElementById("modeSwitch").addEventListener("click", function () {
				audio.play();
			});
			document.getElementById("colorMenuBtn").addEventListener("click", function () {
				audio.play();
			});
		}
		
		allotherthings()
		const drawingModuleInstance = new DrawingModule("back");
		const map = new Map("top");
		//colors of the palette !
		let selectedColor = drawingModuleInstance.palette[0];//base color
		colorMenuBtn.style.backgroundColor = selectedColor; //set the initial color of the background button
		colorOverlay.style.display = 'none';
		// Create color swatches
		drawingModuleInstance.palette.forEach(hex => {
			const swatch = document.createElement('div');
			swatch.classList.add("color-swatch");
			swatch.style.backgroundColor = hex;
			swatch.addEventListener('click', () => {
				audio.play();
				selectedColor = hex;
				colorMenuBtn.style.backgroundColor = hex;
				colorOverlay.style.display = 'none';
				// update your drawing module
				if (drawingModuleInstance) {
					drawingModuleInstance.currentColor = drawingModuleInstance.hexToRgbObject(selectedColor);
				}
			});
			document.getElementById("colorGrid").appendChild(swatch);
		});

		// 1. Select the slider and value span
		const radiusSlider = document.getElementById("radiusSlider");
		const radiusValueDisplay = document.getElementById("radiusValue");

		// 2. Define the update function
		const updateSliderThumb = () => {
			const val = radiusSlider.value;

			// Update the text number
			radiusValueDisplay.innerText = val;

			// Update the CSS variable on the slider element itself
			radiusSlider.style.setProperty('--thumb-radius', `${val * 0.8}px`);

			// Optional: Update drawing module radius immediately if needed
			if (typeof drawingModuleInstance !== 'undefined') {
				// Assuming your drawing module has a property for radius
				// drawingModuleInstance.radius = val; 
			}
		};

		// 3. Add the Event Listener
		radiusSlider.addEventListener("input", updateSliderThumb);

		// 4. Run once on load to set initial size (fixes the "pop" on first click)
		updateSliderThumb();

		let sleep = () => { };
		if (document.location.href.includes("rewind")) {
			sleep = (ms) => {
				return new Promise(resolve => setTimeout(resolve, ms));
			}
		}

		let count = 0;
		const countElem = document.getElementById("count")
		const sendMessage = await setupWebsocket(async (d) => {
			const events = Event.deserialize_list(await d.arrayBuffer());
			for (let event of events) {
				await sleep(1)
				if (event.type == DrawingEventType.USER_CONNECTED) {
					count += 1;
					countElem.innerHTML = count;
				}
				if (event.type == DrawingEventType.USER_DISCONNECTED) {
					count -= 1;
					countElem.innerHTML = count;
				}
				if (event.type == DrawingEventType.ADD_ZONE) {
					map.zones.push(event);
					map.redraw();
				} else {
					drawingModuleInstance.HandleEvent(event);

				}

			}

		});

		if (isDraw) {
			document.getElementById("top").style.pointerEvents = "none";
			drawingModuleInstance.listen(sendMessage);
		}

		if (!isDraw) {
			map.setupHandlers();
		}


	</script>

</body>

</html>
