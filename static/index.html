<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>drawit</title>
	<link rel="stylesheet" href="/static/index.css">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<script src='/static/external/panzoom.min.js'></script>

</head>

<body>




	<div id="viewport">
		<div id="canvas-container">
			<canvas id="canva_index" width="3840" height="2160"></canvas>
		</div>
		<div>
			<a id="startbtn"> </a>
		</div>
	</div>
	</div>



	<script type="module">
		import { DrawingModule } from '/static/draw.js';
		import { Event, DrawingEventType } from "/static/events.js"
		const params = new URLSearchParams(window.location.search);
		const dumpName = params.get("name") || "index"; // default to "index" for index.html
		let dumpFile;
		const blkpath = `/static/saved/blank.js`;
		const blkdumpFile = await import(blkpath);

		//tries to import the specified dump file, falls back to index.js if not found
		try {
			const path = `/static/saved/${dumpName}.js`;
			dumpFile = await import(path);
		} catch (err) {
			console.warn(`Could not import /static/saved/${dumpName}.js, falling back to index`, err);
			try {
				dumpFile = await import('/static/saved/index.js');
			} catch (err2) {
				console.error('Fallback /static/saved/index.js not found', err2);
				dumpFile = { dumpBytes: new Uint8Array(0) };
			}
		}
		const dumpBytes = dumpFile.dumpBytes;
		const drawingModuleInstance = new DrawingModule("canva_index");
		//colors of the palette !

		let sleep = () => { };
		sleep = (ms) => {
			return new Promise(resolve => setTimeout(resolve, ms));
		}



		const events = Event.deserialize_list(dumpBytes.buffer);
		for (let i = 0; i < events.length; i++) {
			const event = events[i];
			if (i % 5 === 0) {
				await sleep(1)
			}
			drawingModuleInstance.HandleEvent(event);

		}
		
		document.getElementById("startbtn").classList.add("enabled")
		
		const audio = new Audio('static/assets/button.wav');
		document.getElementById("startbtn").addEventListener("click", async () => {
            audio.play();

							const events = Event.deserialize_list(blkdumpFile.dumpBytes.buffer);
							for (let i = 0; i < events.length; i++) {
								const event = events[i];
								if (i % 5 === 0) {
									await sleep(1)
								}
								drawingModuleInstance.HandleEvent(event);

							}

            window.location.replace(window.location.origin + "/plan");
        });

	</script>


</body>

</html>
